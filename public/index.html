<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nyatter Ultra | Quantum Authority v6.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Outfit:wght@300;400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --glass: rgba(15, 15, 25, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #6366f1;
            /* Official Rank Spectrum */
            --rank-dev: #ff004c;
            --rank-owner: #a855f7;
            --rank-superadmin: #ff00d4;
            --rank-admin: #fbbf24;
            --rank-mod: #10b981;
            --rank-member: #94a3b8;
        }

        /* --- CORE STYLES --- */
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(255, 0, 76, 0.05) 0%, transparent 40%);
        }

        .mono { font-family: 'JetBrains Mono', monospace; }
        .heading { font-family: 'Space Grotesk', sans-serif; }

        /* --- GLASS & BLUR --- */
        .glass { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .glass-panel { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(40px); border: 1px solid var(--border); }
        
        /* --- DYNAMIC RANK BADGES --- */
        .badge {
            font-size: 10px; font-weight: 900; padding: 2px 10px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 1px; display: inline-flex; align-items: center;
        }
        .b-dev { background: var(--rank-dev); color: white; box-shadow: 0 0 15px rgba(255, 0, 76, 0.4); }
        .b-owner { background: var(--rank-owner); color: white; box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }
        .b-superadmin { background: var(--rank-superadmin); color: white; }
        .b-admin { background: var(--rank-admin); color: black; }
        .b-mod { background: var(--rank-mod); color: white; }
        .b-member { background: var(--rank-member); color: white; opacity: 0.6; }

        /* --- UI OVERLAYS --- */
        .overlay {
            position: fixed; inset: 0; z-index: 5000;
            background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(25px);
            display: none; align-items: center; justify-content: center;
            opacity: 0; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .overlay.active { display: flex; opacity: 1; }

        /* --- FEED ARCHITECTURE --- */
        .post-container { border-bottom: 1px solid var(--border); transition: 0.3s; }
        .post-container:hover { background: rgba(255, 255, 255, 0.02); }
        
        .pfp-square { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; background: #111; border: 1px solid var(--border); }
        .pfp-small { width: 30px; height: 30px; border-radius: 8px; object-fit: cover; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* --- ANIMATIONS --- */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px rgba(99, 102, 241, 0.2); }
            50% { box-shadow: 0 0 25px rgba(99, 102, 241, 0.5); }
            100% { box-shadow: 0 0 10px rgba(99, 102, 241, 0.2); }
        }
        .btn-primary {
            background: var(--accent); color: white; font-weight: 800;
            transition: 0.3s; animation: pulse-glow 3s infinite;
        }
        .btn-primary:hover { transform: scale(1.02); filter: brightness(1.2); }

        .input-box {
            background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
            border-radius: 15px; padding: 12px 20px; color: white; outline: none; transition: 0.3s;
        }
        .input-box:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.07); }

    </style>
</head>
<body class="flex justify-center">

    <div id="auth-gate" class="fixed inset-0 z-[9999] flex items-center justify-center glass-panel">
        <div class="w-full max-w-md p-12 text-center">
            <h1 class="text-7xl font-black heading mb-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 bg-clip-text text-transparent tracking-tighter">NYATTER</h1>
            <p class="text-slate-500 mono text-[10px] uppercase tracking-[0.5em] mb-12">Universal Node v6.1</p>

            <div id="auth-login" class="space-y-4">
                <input type="text" id="log-id" placeholder="Grid Identifier" class="w-full input-box">
                <input type="password" id="log-pass" placeholder="Security Key" class="w-full input-box">
                <button onclick="handleLogin()" class="w-full py-4 rounded-xl btn-primary uppercase text-xs tracking-widest">Access Frequency</button>
                <button onclick="switchAuth(true)" class="text-slate-500 text-xs mt-4 block mx-auto hover:text-white transition">New Signal? Create Identity</button>
            </div>

            <div id="auth-signup" class="hidden space-y-4">
                <div class="flex justify-center mb-6">
                    <label class="relative cursor-pointer group">
                        <img id="reg-pfp-preview" src="default.png" class="w-24 h-24 pfp-square border-2 border-dashed border-slate-700 group-hover:border-indigo-500 transition-all">
                        <input type="file" id="reg-file" class="hidden" accept="image/*" onchange="processFile(event, 'reg-pfp-preview')">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center text-[9px] font-black uppercase rounded-xl transition-all">Upload</div>
                    </label>
                </div>
                <input type="text" id="reg-user" placeholder="Callsign" class="w-full input-box">
                <input type="email" id="reg-email" placeholder="Email Address" class="w-full input-box">
                <input type="password" id="reg-pass" placeholder="Password" class="w-full input-box">
                <button onclick="handleSignup()" class="w-full py-4 rounded-xl btn-primary uppercase text-xs tracking-widest">Establish Link</button>
                <button onclick="switchAuth(false)" class="text-slate-500 text-xs mt-4 block mx-auto hover:text-white transition">Existing Link? Sign In</button>
            </div>
            <div id="auth-error" class="hidden mt-6 text-red-500 mono text-[10px] p-4 bg-red-500/10 rounded-xl border border-red-500/20"></div>
        </div>
    </div>

    <div id="admin-overlay" class="overlay" onclick="hideOverlays()">
        <div class="w-full max-w-4xl glass-panel p-12 rounded-[3rem] shadow-2xl relative border border-white/10" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-12">
                <div class="flex items-center gap-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-purple-600 rounded-2xl flex items-center justify-center text-4xl shadow-lg">‚ö°</div>
                    <div>
                        <h2 class="text-4xl font-black heading text-white">Grid Terminal</h2>
                        <p id="admin-status-text" class="text-slate-500 mono text-xs mt-1 uppercase tracking-widest"></p>
                    </div>
                </div>
                <button onclick="hideOverlays()" class="w-12 h-12 rounded-full border border-white/10 flex items-center justify-center text-xl hover:bg-white/5 transition">‚úï</button>
            </div>

            <div class="grid grid-cols-3 gap-6">
                <div class="col-span-2 glass p-8 rounded-3xl border border-white/5">
                    <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <span class="w-2 h-2 bg-indigo-500 rounded-full"></span> Active Node Directory
                    </h3>
                    <div id="admin-user-list" class="space-y-3 max-h-[300px] overflow-y-auto custom-scroll pr-4">
                        </div>
                </div>

                <div class="space-y-6">
                    <div class="glass p-6 rounded-3xl border border-white/5 bg-red-500/5">
                        <h3 class="text-[10px] font-black text-red-400 uppercase tracking-widest mb-4">Nuclear Options</h3>
                        <button id="admin-wipe-btn" onclick="triggerWipe()" class="hidden w-full py-3 bg-red-500/20 hover:bg-red-500 text-red-500 hover:text-white rounded-xl font-black text-[9px] uppercase transition-all mb-3">Wipe Global Database</button>
                        <p class="text-[9px] text-slate-600 font-bold uppercase leading-tight">Note: Nuclear actions require OWNER or DEV clearance levels.</p>
                    </div>

                    <div class="glass p-6 rounded-3xl border border-white/5">
                        <h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-4">System Protocol</h3>
                        <div class="space-y-2 text-[10px] mono text-slate-500">
                            <div class="flex justify-between"><span>DB STATUS</span><span class="text-emerald-500">OPTIMAL</span></div>
                            <div class="flex justify-between"><span>LATENCY</span><span class="text-emerald-500">14MS</span></div>
                            <div class="flex justify-between"><span>ENCRYPTION</span><span class="text-indigo-500">AES-256</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-center">
                <p class="text-[10px] mono text-slate-700 font-bold uppercase tracking-[0.3em]">Press <span class="text-white bg-white/10 px-2 py-1 rounded">X</span> to Toggle Terminal Interface</p>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden w-full max-w-[1440px] h-screen flex relative">
        
        <aside class="w-[300px] p-10 border-r border-white/5 flex flex-col bg-slate-950/20">
            <div class="mb-16">
                <span class="text-4xl font-black heading tracking-tighter bg-gradient-to-r from-indigo-400 to-purple-500 bg-clip-text text-transparent">NYATTER</span>
            </div>
            
            <nav class="flex-1 space-y-3">
                <button class="w-full flex items-center gap-5 px-6 py-4 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 text-white font-bold group">
                    <span class="text-xl group-hover:scale-125 transition">üè†</span> Home Stream
                </button>
                <button onclick="toggleOverlay('notif-overlay')" class="w-full flex items-center gap-5 px-6 py-4 rounded-2xl text-slate-400 hover:text-white hover:bg-white/5 transition relative">
                    <span class="text-xl">üîî</span> Notifications
                    <div id="notif-indicator" class="hidden absolute top-5 right-6 w-2 h-2 bg-pink-500 rounded-full animate-pulse shadow-[0_0_10px_#ec4899]"></div>
                </button>
                <button onclick="toggleOverlay('admin-overlay')" class="w-full flex items-center gap-5 px-6 py-4 rounded-2xl text-slate-400 hover:text-white hover:bg-indigo-500/5 transition">
                    <span class="text-xl">üõ°Ô∏è</span> Authority <span class="ml-auto mono text-[9px] opacity-40">[X]</span>
                </button>
            </nav>

            <div onclick="toggleOverlay('settings-overlay')" class="mt-auto p-5 rounded-[2.5rem] glass hover:border-indigo-500/50 transition-all cursor-pointer group">
                <div class="flex items-center gap-4">
                    <img id="u-pfp-nav" src="default.png" class="pfp-square w-12 h-12 shadow-lg">
                    <div class="overflow-hidden">
                        <p class="font-bold text-sm truncate text-white" id="u-name-nav"></p>
                        <div id="u-rank-nav" class="mt-1"></div>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col border-r border-white/5 bg-black/30 backdrop-blur-md">
            <header class="h-24 px-8 glass border-t-0 border-x-0 flex items-center justify-between sticky top-0 z-[100]">
                <h2 class="text-2xl font-black heading tracking-tight">Global Frequency</h2>
                <div class="flex gap-4">
                    <div class="relative">
                        <input type="text" id="search-in" placeholder="Search grid..." class="bg-white/5 border border-white/5 rounded-full px-6 py-2 text-xs w-64 outline-none focus:border-indigo-500 transition-all">
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto custom-scroll" id="scroll-engine">
                <div class="p-10 border-b border-white/5">
                    <div class="flex gap-8">
                        <img id="u-pfp-composer" src="default.png" class="pfp-square shadow-2xl">
                        <div class="flex-1">
                            <textarea id="post-input" placeholder="What's your signal today?" class="w-full bg-transparent text-2xl outline-none resize-none h-28 pt-2 text-white placeholder-slate-800 font-light"></textarea>
                            <div id="composer-preview" class="mb-4"></div>
                            
                            <div class="flex justify-between items-center pt-6 border-t border-white/5">
                                <div class="flex gap-2">
                                    <label class="w-12 h-12 rounded-2xl flex items-center justify-center bg-white/5 hover:bg-white/10 cursor-pointer transition">
                                        üñºÔ∏è<input type="file" class="hidden" accept="image/*" onchange="processFile(event, 'composer-preview')">
                                    </label>
                                    <button class="w-12 h-12 rounded-2xl flex items-center justify-center bg-white/5 hover:bg-white/10 transition">üìç</button>
                                </div>
                                <button onclick="sendTransmission()" class="px-12 py-3 rounded-full btn-primary text-xs uppercase tracking-widest font-black">Broadcast</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="post-stream" class="divide-y divide-white/5">
                    </div>
            </div>
        </main>

        <aside class="w-[360px] p-10 hidden lg:flex flex-col bg-slate-950/20">
            <div class="glass p-8 rounded-[3rem] flex-1 flex flex-col">
                <h3 class="text-[11px] font-black text-slate-500 uppercase tracking-[0.3em] mb-10 flex items-center gap-3">
                    <span class="w-2 h-2 bg-pink-500 rounded-full animate-ping"></span>
                    Grid Discovery
                </h3>
                
                <div id="sidebar-users" class="space-y-6 overflow-y-auto custom-scroll flex-1 pr-2">
                    </div>

                <div class="mt-10 pt-8 border-t border-white/5">
                    <div class="p-5 glass rounded-2xl bg-indigo-500/5">
                        <p class="text-[10px] text-indigo-300 font-black uppercase mb-1">Grid System Upgraded</p>
                        <p class="text-[9px] text-slate-500 leading-relaxed">Multi-rank authority and nuclear protocols are now active on this node.</p>
                    </div>
                </div>
            </div>
        </aside>

    </div>

    <script>
        // --- GLOBAL STATE ---
        let CURRENT_USER = null;
        let ACTIVE_IMAGE = null;
        let REFRESH_INTERVAL = null;
        let PREVENT_REFRESH = false;

        // --- KEYBOARD SHORTCUTS ---
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'x' && CURRENT_USER) {
                // Don't trigger if user is typing
                if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
                toggleOverlay('admin-overlay');
            }
        });

        // --- AUTHENTICATION ENGINE ---
        function switchAuth(isSignup) {
            document.getElementById('auth-login').classList.toggle('hidden', isSignup);
            document.getElementById('auth-signup').classList.toggle('hidden', !isSignup);
            document.getElementById('auth-error').classList.add('hidden');
        }

        function processFile(e, previewId) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                const result = reader.result;
                if (previewId === 'composer-preview') {
                    ACTIVE_IMAGE = result;
                    document.getElementById(previewId).innerHTML = `
                        <div class="relative mt-4 group">
                            <img src="${result}" class="w-full rounded-2xl border border-white/10 shadow-2xl max-h-[400px] object-cover">
                            <button onclick="clearImage()" class="absolute top-4 right-4 w-10 h-10 bg-black/80 rounded-full text-white hover:bg-red-600 transition">‚úï</button>
                        </div>
                    `;
                } else {
                    document.getElementById(previewId).src = result;
                }
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            ACTIVE_IMAGE = null;
            document.getElementById('composer-preview').innerHTML = "";
        }

        async function handleLogin() {
            const id = document.getElementById('log-id').value.trim();
            const pass = document.getElementById('log-pass').value.trim();
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ identifier: id, password: pass })
            });
            const data = await res.json();
            if (data.error) return showError(data.error);
            initializeSession(data.user);
        }

        async function handleSignup() {
            const user = document.getElementById('reg-user').value.trim();
            const email = document.getElementById('reg-email').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();
            const pfp = document.getElementById('reg-pfp-preview').src;

            const res = await fetch('/api/signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    username: user, 
                    email, 
                    password: pass, 
                    pfp: pfp.includes('default.png') ? '' : pfp 
                })
            });
            const data = await res.json();
            if (data.error) return showError(data.error);
            initializeSession(data.user);
        }

        function initializeSession(user) {
            CURRENT_USER = user;
            localStorage.setItem('nyatter_user', JSON.stringify(user));
            
            document.getElementById('auth-gate').classList.add('hidden');
            document.getElementById('app-shell').classList.remove('hidden');
            
            // UI Setup
            document.getElementById('u-name-nav').innerText = "@" + user.username;
            document.getElementById('u-pfp-nav').src = user.pfp || 'default.png';
            document.getElementById('u-pfp-composer').src = user.pfp || 'default.png';
            document.getElementById('u-rank-nav').innerHTML = generateBadge(user.rank);
            document.getElementById('admin-status-text').innerText = `CALLSIGN: ${user.username} | AUTHORITY: ${user.rank}`;

            // Show nuclear options for high ranks
            if (['owner', 'dev'].includes(user.rank.toLowerCase())) {
                document.getElementById('admin-wipe-btn').classList.remove('hidden');
            }

            refreshAll();
            REFRESH_INTERVAL = setInterval(() => { if (!PREVENT_REFRESH) refreshAll(); }, 5000);
        }

        // --- CONTENT REFRESH LOGIC ---
        async function refreshAll() {
            await fetchUsers();
            await fetchPosts();
        }

        async function fetchUsers() {
            const res = await fetch('/api/users');
            const users = await res.json();
            
            // Sidebar List
            const sidebar = document.getElementById('sidebar-users');
            sidebar.innerHTML = users.map(u => `
                <div class="flex items-center gap-4 group">
                    <img src="${u.pfp || 'default.png'}" class="w-10 h-10 pfp-square group-hover:border-indigo-500 transition-all">
                    <div>
                        <p class="text-xs font-bold text-white">@${u.username}</p>
                        ${generateBadge(u.rank)}
                    </div>
                </div>
            `).join('');

            // Admin List
            const adminList = document.getElementById('admin-user-list');
            adminList.innerHTML = users.map(u => `
                <div class="flex items-center justify-between p-4 glass rounded-2xl hover:bg-white/5 transition">
                    <div class="flex items-center gap-4">
                        <img src="${u.pfp || 'default.png'}" class="w-8 h-8 pfp-square">
                        <span class="font-bold text-white text-sm">@${u.username}</span>
                        ${generateBadge(u.rank)}
                    </div>
                    <div class="flex gap-2">
                        ${['owner', 'dev'].includes(CURRENT_USER.rank.toLowerCase()) ? `
                            <button onclick="promote('${u.username}')" class="px-4 py-2 bg-indigo-500/10 text-indigo-400 text-[9px] font-black rounded-lg uppercase hover:bg-indigo-500 hover:text-white transition">Promote</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function fetchPosts() {
            const res = await fetch('/api/posts');
            const posts = await res.json();
            const stream = document.getElementById('post-stream');

            stream.innerHTML = posts.map(p => {
                const r = CURRENT_USER.rank.toLowerCase();
                const canDelete = ['mod', 'admin', 'superadmin', 'owner', 'dev'].includes(r) || p.user === CURRENT_USER.username;
                const canPin = ['admin', 'superadmin', 'owner', 'dev'].includes(r);

                return `
                    <div class="p-10 post-container flex gap-8 ${p.pinned ? 'bg-indigo-500/[0.03] border-l-4 border-amber-400' : ''}">
                        <img src="${p.userPfp || 'default.png'}" class="pfp-square w-14 h-14">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="text-lg font-black text-white">@${p.user}</span>
                                    ${generateBadge(p.userRank)}
                                    ${p.pinned ? '<span class="text-[10px] text-amber-500 font-black mono tracking-widest ml-4">üìå PINNED BY AUTH</span>' : ''}
                                </div>
                                <div class="flex gap-4 opacity-0 group-hover:opacity-100 transition-opacity">
                                    ${canPin ? `<button onclick="modAction('TOGGLE_PIN', '${p._id}')" class="text-[10px] font-black text-slate-500 hover:text-amber-500">PIN</button>` : ''}
                                    ${canDelete ? `<button onclick="modAction('DELETE_POST', '${p._id}')" class="text-[10px] font-black text-slate-500 hover:text-red-500">DELETE</button>` : ''}
                                </div>
                            </div>
                            <p class="text-xl text-slate-300 font-light leading-relaxed">${formatText(p.text)}</p>
                            ${p.img ? `<img src="${p.img}" class="w-full rounded-3xl mt-6 border border-white/5 shadow-2xl">` : ''}
                            
                            <div class="mt-8 pt-6 border-t border-white/5 space-y-6">
                                ${p.replies.map(re => `
                                    <div class="flex gap-4 items-center">
                                        <img src="${re.userPfp || 'default.png'}" class="pfp-small">
                                        <p class="text-sm text-slate-400"><span class="font-bold text-indigo-400">@${re.user}</span> ${formatText(re.text)}</p>
                                        ${generateBadge(re.userRank)}
                                    </div>
                                `).join('')}
                                <div class="flex gap-4 mt-4">
                                    <input id="reply-${p._id}" onfocus="PREVENT_REFRESH=true" onblur="setTimeout(()=>PREVENT_REFRESH=false,500)" placeholder="Send a reply..." class="flex-1 bg-white/5 border border-white/5 rounded-xl px-5 py-3 text-xs text-white outline-none focus:border-indigo-500 transition">
                                    <button onclick="sendReply('${p._id}')" class="text-indigo-400 font-black text-[10px] uppercase tracking-widest hover:text-white transition">Reply</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- ACTIONS ---
        async function sendTransmission() {
            const txt = document.getElementById('post-input').value.trim();
            if (!txt && !ACTIVE_IMAGE) return;
            await fetch('/api/posts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: CURRENT_USER.username, text: txt, img: ACTIVE_IMAGE })
            });
            document.getElementById('post-input').value = "";
            clearImage();
            refreshAll();
        }

        async function sendReply(postId) {
            const input = document.getElementById(`reply-${postId}`);
            if (!input.value.trim()) return;
            await fetch('/api/posts/reply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: postId, user: CURRENT_USER.username, text: input.value.trim() })
            });
            input.value = "";
            refreshAll();
        }

        async function modAction(action, targetId) {
            await fetch('/api/admin/action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adminUser: CURRENT_USER.username, action, targetId })
            });
            refreshAll();
        }

        async function triggerWipe() {
            if (!confirm("‚ò¢Ô∏è NUCLEAR PROTOCOL: ARE YOU CERTAIN?")) return;
            const res = await fetch('/api/admin/action', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ adminUser: CURRENT_USER.username, action: 'WIPE_ALL' })
            });
            if (res.ok) { alert("Grid Reset."); location.reload(); }
        }

        // --- CONSOLE COMMANDS ---
        window.promote = (target, rank) => {
            if (!rank) rank = prompt("Target Rank: mod, admin, superadmin, owner, dev");
            fetch('/api/admin/promote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUser: target, rank: rank.toLowerCase(), requester: CURRENT_USER.username })
            }).then(r => r.json()).then(d => {
                alert(d.message || d.error);
                refreshAll();
            });
        };

        // --- HELPERS ---
        function generateBadge(rank) {
            if (!rank) return '';
            const r = rank.toLowerCase();
            const styles = { dev:'b-dev', owner:'b-owner', superadmin:'b-superadmin', admin:'b-admin', mod:'b-mod' };
            return `<span class="badge ${styles[r] || 'b-member'}">${rank}</span>`;
        }

        function formatText(t) {
            return t.replace(/@(\w+)/g, (match, name) => `<span class="text-pink-500 font-bold">${match}</span>`);
        }

        function toggleOverlay(id) { document.getElementById(id).classList.toggle('active'); }
        function hideOverlays() { document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active')); }
        function showError(m) { const e = document.getElementById('auth-error'); e.innerText = m; e.classList.remove('hidden'); }

        window.onload = () => {
            const saved = localStorage.getItem('nyatter_user');
            if (saved) initializeSession(JSON.parse(saved));
        };
    </script>
</body>
</html>
