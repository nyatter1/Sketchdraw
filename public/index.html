<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SketchDash Pro - Ultimate Drawing Battle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #f59e0b;
            --bg: #0f172a;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg);
            color: white;
            overflow: hidden;
            touch-action: none;
        }

        .font-brand { font-family: 'Fredoka One', cursive; }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .canvas-container {
            aspect-ratio: 16 / 9;
            background: white;
            cursor: crosshair;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            position: relative;
            transition: transform 0.2s;
        }

        .accessory-overlay {
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 1.8rem;
        }

        .chat-bubble {
            animation: slideIn 0.2s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .btn-hover {
            transition: all 0.2s;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        #timer-ring {
            transition: stroke-dashoffset 1s linear;
        }

        .correct-guess-flash {
            animation: flashGreen 1s ease-out;
        }

        @keyframes flashGreen {
            0% { background-color: transparent; }
            50% { background-color: rgba(34, 197, 94, 0.3); }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-4">

    <!-- LOGIN / LOBBY SCREEN -->
    <div id="lobby-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950 p-6">
        <div class="glass-panel w-full max-w-lg p-8 space-y-8 text-center">
            <h1 class="text-5xl font-brand text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-500">SKETCH DASH</h1>
            
            <!-- Character Customizer -->
            <div class="flex flex-col items-center space-y-6">
                <div id="lobby-avatar" class="avatar-preview bg-indigo-500 border-4 border-white shadow-2xl">
                    <span id="base-emoji">üê±</span>
                    <span id="acc-emoji" class="accessory-overlay">üé©</span>
                </div>

                <div class="w-full space-y-4">
                    <input type="text" id="username-input" maxlength="15" placeholder="Enter Username..." 
                        class="w-full px-4 py-3 bg-slate-800 border-2 border-indigo-500/30 rounded-xl text-center text-xl focus:border-indigo-500 outline-none">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="changeBase()" class="bg-slate-700 p-3 rounded-lg hover:bg-slate-600 transition">Change Base</button>
                        <button onclick="changeAccessory()" class="bg-slate-700 p-3 rounded-lg hover:bg-slate-600 transition">Change Accessory</button>
                    </div>
                </div>
            </div>

            <button onclick="joinGame()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl font-bold text-2xl shadow-lg btn-hover">
                PLAY NOW
            </button>

            <div class="text-slate-400 text-sm">
                Persistent Wins: <span id="persistent-wins" class="text-indigo-400">0</span> | 
                Rank: <span id="persistent-rank" class="text-pink-400">NOVICE</span>
            </div>
        </div>
    </div>

    <!-- MAIN GAME HUD -->
    <div id="game-screen" class="hidden w-full h-full max-w-7xl flex flex-col gap-4">
        
        <!-- Header -->
        <div class="h-20 flex items-center justify-between px-6 glass-panel">
            <div class="flex items-center gap-4">
                <div class="relative w-14 h-14">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="28" cy="28" r="24" stroke="currentColor" stroke-width="4" fill="transparent" class="text-slate-700" />
                        <circle id="timer-ring" cx="28" cy="28" r="24" stroke="currentColor" stroke-width="4" fill="transparent" 
                            stroke-dasharray="150.8" stroke-dashoffset="0" class="text-indigo-500" />
                    </svg>
                    <span id="timer-text" class="absolute inset-0 flex items-center justify-center font-bold text-lg">60</span>
                </div>
                <div>
                    <div id="round-display" class="text-xs uppercase tracking-widest text-slate-400">Round 1/10</div>
                    <div id="word-display" class="text-2xl font-brand tracking-[0.3em] text-white">_ _ _ _ _</div>
                </div>
            </div>

            <div id="game-status-msg" class="text-indigo-400 font-bold animate-pulse">Waiting for players...</div>

            <button onclick="leaveGame()" class="px-4 py-2 bg-slate-800 hover:bg-red-900/50 rounded-lg text-sm transition">Leave</button>
        </div>

        <div class="flex-1 flex gap-4 min-h-0">
            <!-- Left Sidebar: Players -->
            <div class="w-64 glass-panel flex flex-col overflow-hidden">
                <div class="p-4 border-b border-white/10 font-bold">PLAYERS</div>
                <div id="player-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                    <!-- Players injected here -->
                </div>
            </div>

            <!-- Middle: Canvas Area -->
            <div class="flex-1 flex flex-col gap-4 min-w-0">
                <div class="relative flex-1 glass-panel p-2 overflow-hidden flex flex-col">
                    <!-- Canvas -->
                    <div id="canvas-wrapper" class="relative flex-1 bg-white rounded-xl overflow-hidden">
                        <canvas id="drawing-canvas"></canvas>
                        
                        <!-- Word Selection Overlay -->
                        <div id="word-picker" class="hidden absolute inset-0 z-20 bg-slate-900/90 flex flex-col items-center justify-center p-6 text-center">
                            <h2 class="text-3xl font-brand mb-8">Choose a word to draw!</h2>
                            <div id="word-options" class="flex flex-wrap justify-center gap-4">
                                <!-- Buttons injected -->
                            </div>
                        </div>

                        <!-- Intermission Overlay -->
                        <div id="intermission-overlay" class="hidden absolute inset-0 z-20 bg-indigo-900/80 flex flex-col items-center justify-center text-center">
                            <div class="text-xl text-indigo-200 mb-2">The word was</div>
                            <div id="revealed-word" class="text-6xl font-brand mb-6">APPLE</div>
                            <div id="winner-reveal" class="text-2xl">No one guessed it!</div>
                        </div>
                    </div>

                    <!-- Toolbar -->
                    <div id="toolbar" class="h-16 flex items-center justify-between px-4 mt-2 hidden">
                        <div class="flex items-center gap-3">
                            <input type="color" id="color-picker" class="w-10 h-10 rounded cursor-pointer bg-transparent" value="#000000">
                            <div class="flex gap-1">
                                <button onclick="setBrush(3)" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><div class="w-1 h-1 bg-white rounded-full"></div></button>
                                <button onclick="setBrush(8)" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><div class="w-3 h-3 bg-white rounded-full"></div></button>
                                <button onclick="setBrush(15)" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><div class="w-5 h-5 bg-white rounded-full"></div></button>
                            </div>
                        </div>
                        <button onclick="clearCanvas()" class="px-6 py-2 bg-red-600 hover:bg-red-500 rounded-lg font-bold transition">CLEAR</button>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Chat -->
            <div class="w-80 glass-panel flex flex-col overflow-hidden">
                <div class="p-4 border-b border-white/10 font-bold">CHAT & GUESSES</div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 text-sm">
                    <!-- Messages injected -->
                </div>
                <form id="chat-form" class="p-4 bg-slate-900/50">
                    <input type="text" id="chat-input" placeholder="Type your guess..." 
                        class="w-full bg-slate-800 border-none rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
                </form>
            </div>
        </div>
    </div>

    <!-- UI Audio Elements -->
    <audio id="sfx-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <script>
        // --- CONSTANTS & STATE ---
        const BASES = ["üê±", "üê∂", "üêª", "ü¶ä", "ü¶Å", "üê∏", "üêº", "üê®", "üê∑"];
        const ACCESSORIES = ["üé©", "üëë", "üëí", "üéì", "üéÄ", "üï∂Ô∏è", "üé®", "üöÄ", "üî•", "üíé"];
        
        let socket;
        let myData = {
            name: localStorage.getItem('sketch_name') || "Player" + Math.floor(Math.random() * 1000),
            base: localStorage.getItem('sketch_base') || "üê±",
            accessory: localStorage.getItem('sketch_acc') || "üé©",
            wins: parseInt(localStorage.getItem('sketch_wins')) || 0,
            totalPoints: parseInt(localStorage.getItem('sketch_points')) || 0
        };

        const canvas = document.getElementById('drawing-canvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastPos = { x: 0, y: 0 };
        let brushColor = "#000000";
        let brushSize = 5;
        let amIDrawing = false;

        // --- INITIALIZATION ---
        window.onload = () => {
            updateLobbyPreview();
            document.getElementById('username-input').value = myData.name;
            document.getElementById('persistent-wins').innerText = myData.wins;
            document.getElementById('persistent-rank').innerText = calculateRank(myData.wins);
            
            // Handle Resize
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        };

        function calculateRank(wins) {
            if (wins >= 250) return "GALLERY GOD";
            if (wins >= 100) return "ILLUSTRATOR";
            if (wins >= 40) return "INK MASTER";
            if (wins >= 15) return "SKETCH ARTIST";
            if (wins >= 5) return "ROOKIE";
            return "NOVICE";
        }

        // --- LOBBY LOGIC ---
        function changeBase() {
            const idx = BASES.indexOf(myData.base);
            myData.base = BASES[(idx + 1) % BASES.length];
            updateLobbyPreview();
            saveData();
        }

        function changeAccessory() {
            const idx = ACCESSORIES.indexOf(myData.accessory);
            myData.accessory = ACCESSORIES[(idx + 1) % ACCESSORIES.length];
            updateLobbyPreview();
            saveData();
        }

        function updateLobbyPreview() {
            document.getElementById('base-emoji').innerText = myData.base;
            document.getElementById('acc-emoji').innerText = myData.accessory;
        }

        function saveData() {
            localStorage.setItem('sketch_name', myData.name);
            localStorage.setItem('sketch_base', myData.base);
            localStorage.setItem('sketch_acc', myData.accessory);
            localStorage.setItem('sketch_wins', myData.wins);
            localStorage.setItem('sketch_points', myData.totalPoints);
        }

        function joinGame() {
            const nameInput = document.getElementById('username-input').value.trim();
            if(!nameInput) return;
            myData.name = nameInput;
            saveData();

            // Connect to Socket
            socket = io(); // In production, pass the server URL if different

            socket.on('connect', () => {
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                socket.emit('join_game', myData);
            });

            setupSocketListeners();
        }

        function leaveGame() {
            location.reload();
        }

        // --- SOCKET LISTENERS ---
        function setupSocketListeners() {
            socket.on('player_list_update', (players) => {
                const list = document.getElementById('player-list');
                list.innerHTML = players.sort((a,b) => b.score - a.score).map(p => `
                    <div class="flex items-center gap-3 p-2 rounded-lg bg-slate-800/50 ${p.id === socket.id ? 'border border-indigo-500' : ''} ${p.hasGuessed ? 'bg-green-900/30' : ''}">
                        <div class="relative w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center text-xl">
                            ${p.base}
                            <span class="absolute -top-1 -right-1 text-sm">${p.accessory}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold truncate ${p.hasGuessed ? 'text-green-400' : ''}">${p.name}</div>
                            <div class="text-xs text-slate-400">${p.score} pts ‚Ä¢ ${p.rank}</div>
                        </div>
                    </div>
                `).join('');
            });

            socket.on('game_state_update', (state) => {
                const statusMsg = document.getElementById('game-status-msg');
                const wordPicker = document.getElementById('word-picker');
                const toolbar = document.getElementById('toolbar');
                const intermission = document.getElementById('intermission-overlay');
                
                amIDrawing = state.drawerId === socket.id;
                document.getElementById('round-display').innerText = `Round ${state.round}/10`;

                // Status Logic
                if (state.status === 'waiting') {
                    statusMsg.innerText = "Waiting for more players...";
                } else if (state.status === 'selecting') {
                    statusMsg.innerText = amIDrawing ? "Choose a word!" : "Drawer is choosing...";
                    if(amIDrawing) {
                        wordPicker.classList.remove('hidden');
                        const options = document.getElementById('word-options');
                        options.innerHTML = state.wordChoices.map(w => `
                            <button onclick="selectWord('${w}')" class="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl font-bold text-lg btn-hover">${w}</button>
                        `).join('');
                    } else {
                        wordPicker.classList.add('hidden');
                    }
                    intermission.classList.add('hidden');
                } else if (state.status === 'active') {
                    wordPicker.classList.add('hidden');
                    intermission.classList.add('hidden');
                    statusMsg.innerText = amIDrawing ? "DRAW THIS!" : "GUESS THE WORD!";
                    
                    if(amIDrawing) {
                        toolbar.classList.remove('hidden');
                        document.getElementById('word-display').innerText = state.currentWord;
                    } else {
                        toolbar.classList.add('hidden');
                        document.getElementById('word-display').innerText = state.currentWord.replace(/[A-Z]/g, '_ ');
                    }
                } else if (state.status === 'intermission') {
                    toolbar.classList.add('hidden');
                    intermission.classList.remove('hidden');
                    document.getElementById('revealed-word').innerText = state.currentWord;
                    document.getElementById('winner-reveal').innerText = state.winners.length > 0 ? "Correctly guessed by " + state.winners.length + " players!" : "No one got it!";
                }
            });

            socket.on('timer_update', (time) => {
                document.getElementById('timer-text').innerText = time;
                const ring = document.getElementById('timer-ring');
                const offset = (time / 60) * 150.8;
                ring.style.strokeDashoffset = 150.8 - offset;
            });

            socket.on('remote_draw', (data) => drawLine(data.x0, data.y0, data.x1, data.y1, data.color, data.size, false));
            socket.on('remote_clear', () => ctx.clearRect(0, 0, canvas.width, canvas.height));

            socket.on('correct_guess', (data) => {
                document.getElementById('sfx-correct').play();
                addMessage("System", `${data.playerName} guessed the word!`, 'system');
                if(data.playerId === socket.id) {
                    document.body.classList.add('correct-guess-flash');
                    setTimeout(() => document.body.classList.remove('correct-guess-flash'), 1000);
                }
            });

            socket.on('new_message', (msg) => addMessage(msg.user, msg.text, msg.type));
            
            socket.on('game_win', (winnerId) => {
                if(winnerId === socket.id) {
                    myData.wins++;
                    saveData();
                    document.getElementById('sfx-win').play();
                }
            });
        }

        // --- CANVAS LOGIC ---
        function resizeCanvas() {
            const wrapper = document.getElementById('canvas-wrapper');
            const rect = wrapper.getBoundingClientRect();
            // High DPI support
            const dpr = window.devicePixelRatio || 1;
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;
            canvas.style.width = rect.width + 'px';
            canvas.style.height = rect.height + 'px';
            ctx.scale(dpr, dpr);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            if(!amIDrawing) return;
            isDrawing = true;
            lastPos = getPos(e);
        }

        function draw(e) {
            if(!isDrawing || !amIDrawing) return;
            const currentPos = getPos(e);
            drawLine(lastPos.x, lastPos.y, currentPos.x, currentPos.y, brushColor, brushSize, true);
            lastPos = currentPos;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function drawLine(x0, y0, x1, y1, color, size, emit) {
            ctx.beginPath();
            ctx.moveTo(x0, y0);
            ctx.lineTo(x1, y1);
            ctx.strokeStyle = color;
            ctx.lineWidth = size;
            ctx.stroke();
            ctx.closePath();

            if (emit && socket) {
                socket.emit('draw_stroke', { x0, y0, x1, y1, color, size });
            }
        }

        function setBrush(size) { brushSize = size; }
        document.getElementById('color-picker').oninput = (e) => brushColor = e.target.value;

        function clearCanvas() {
            if(!amIDrawing) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            socket.emit('clear_canvas');
        }

        function selectWord(word) {
            socket.emit('word_selected', word);
        }

        // --- CHAT LOGIC ---
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-messages');

        chatForm.onsubmit = (e) => {
            e.preventDefault();
            const val = chatInput.value.trim();
            if(val) {
                socket.emit('send_message', val);
                chatInput.value = '';
            }
        };

        function addMessage(user, text, type) {
            const div = document.createElement('div');
            div.className = `chat-bubble p-2 rounded-lg ${type === 'system' ? 'bg-indigo-900/30 text-indigo-300 italic' : 'bg-slate-800'}`;
            div.innerHTML = `<strong>${user}:</strong> ${text}`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
