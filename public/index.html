<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TikSnap Elite</title>
    <style>
        :root { --bg: #0b0e11; --card: #15191c; --accent: #00a8ff; --text: #ffffff; --border: rgba(255,255,255,0.08); }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }
        #auth-screen { display: flex; align-items: center; justify-content: center; height: 100vh; }
        .auth-card { background: var(--card); padding: 40px; border-radius: 20px; border: 1px solid var(--border); width: 320px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid var(--border); background: #1c2126; color: white; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #app-screen { display: none; height: 100vh; width: 100vw; display: flex; }
        .sidebar { width: 260px; background: var(--card); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg-bubble { display: flex; gap: 10px; }
        .pfp-small { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #333; }
        .msg-content { background: #1c2126; padding: 10px 14px; border-radius: 12px; font-size: 14px; }
        .msg-content b { color: var(--accent); font-size: 11px; display: block; }
        
        /* Modal & Bio Styling */
        #profile-modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; display:none; align-items:center; justify-content:center; }
        .modal-content { background: var(--card); width: 380px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); text-align: center; }
        #v-banner { height: 120px; background-size: cover; background-position: center; cursor: pointer; }
        #v-pfp { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--card); margin-top: -45px; object-fit: cover; cursor: pointer; }
        #v-bio { color: #aaa; font-size: 14px; padding: 15px; border-radius: 8px; outline: none; margin: 10px 20px; display: block; border: 1px solid transparent; transition: 0.3s; }
        #v-bio[contenteditable="true"]:hover { background: rgba(255,255,255,0.05); border: 1px solid var(--border); }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-card">
            <h2>TikSnap</h2>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn-primary" onclick="handleAuth()">Login / Sign Up</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="sidebar">
            <h3 style="color: var(--accent)">TikSnap</h3>
            <div id="online-list" style="flex-grow: 1;"></div>
            <button onclick="logout()" class="btn-primary" style="background:#333">Logout</button>
        </div>
        <div class="chat-main">
            <div id="messages"></div>
            <div style="padding: 20px; display: flex; gap: 10px;">
                <input type="text" id="msg-in" placeholder="Type a message..." style="margin:0" onkeypress="if(event.key==='Enter')send()">
                <button class="btn-primary" onclick="send()" style="width:80px">Send</button>
            </div>
        </div>
    </div>

    <div id="profile-modal">
        <div class="modal-content">
            <div id="v-banner" title="Change Banner"></div>
            <img id="v-pfp" src="" title="Change PFP">
            <h2 id="v-username"></h2>
            <div id="v-bio" contenteditable="false" onkeypress="if(event.key==='Enter'){this.blur(); event.preventDefault();}"></div>
            <p style="font-size: 10px; color: #555;">(Press Enter to save bio)</p>
            <button class="btn-primary" style="width: 100px; margin: 20px;" onclick="closeModal()">Close</button>
        </div>
        <input type="file" id="pfp-up" class="hidden" accept="image/*">
        <input type="file" id="banner-up" class="hidden" accept="image/*">
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myData = null;

        window.onload = () => {
            const saved = localStorage.getItem('tiksnap_user');
            if(saved) { myData = JSON.parse(saved); startApp(); }
        }

        async function handleAuth() {
            const username = document.getElementById('user').value;
            const password = document.getElementById('pass').value;
            const res = await fetch('/auth', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password, type: 'signup' })
            });
            const data = await res.json();
            if(data.success) {
                myData = data.user;
                localStorage.setItem('tiksnap_user', JSON.stringify(myData));
                startApp();
            } else alert(data.message);
        }

        function startApp() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').style.display = 'flex';
            socket.emit('join-chat', myData);
        }

        function logout() { localStorage.removeItem('tiksnap_user'); location.reload(); }

        function send() {
            const i = document.getElementById('msg-in');
            if(i.value) { socket.emit('chat-message', i.value); i.value = ''; }
        }

        socket.on('chat-message', m => addMsg(m));
        socket.on('load-history', msgs => msgs.forEach(m => addMsg(m)));

        function addMsg(m) {
            const div = document.createElement('div');
            div.className = 'msg-bubble';
            div.innerHTML = `<img src="${m.pfp}" class="pfp-small" data-user="${m.user}">
                             <div class="msg-content"><b>${m.user}</b>${m.text}</div>`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        socket.on('update-user-list', users => {
            const list = document.getElementById('online-list');
            list.innerHTML = '';
            users.forEach(u => {
                const item = document.createElement('div');
                item.style.cursor = 'pointer';
                item.innerHTML = `<img src="${u.profilePic}" class="pfp-small" style="width:20px;height:20px"> ${u.username}`;
                item.onclick = () => showProfile(u);
                list.appendChild(item);
            });
        });

        // LIVE PROFILE UPDATE (No reload needed!)
        socket.on('user-profile-updated', (updatedUser) => {
            // Update sidebar & chat PFP in real-time
            document.querySelectorAll(`.pfp-small[data-user="${updatedUser.username}"]`).forEach(img => {
                img.src = updatedUser.profilePic;
            });
            if(myData && updatedUser.username === myData.username) {
                myData = updatedUser;
                localStorage.setItem('tiksnap_user', JSON.stringify(myData));
            }
        });

        function showProfile(u) {
            document.getElementById('v-username').innerText = u.username;
            document.getElementById('v-pfp').src = u.profilePic;
            document.getElementById('v-banner').style.background = u.banner.startsWith('data') ? `url(${u.banner}) center/cover` : u.banner;
            
            const bioEl = document.getElementById('v-bio');
            bioEl.innerText = u.bio;
            document.getElementById('profile-modal').style.display = 'flex';

            if(u.username === myData.username) {
                bioEl.contentEditable = "true";
                bioEl.onblur = () => uploadBio(bioEl.innerText);
                document.getElementById('v-pfp').onclick = () => document.getElementById('pfp-up').click();
                document.getElementById('v-banner').onclick = () => document.getElementById('banner-up').click();
            } else {
                bioEl.contentEditable = "false";
                document.getElementById('v-pfp').onclick = null;
                document.getElementById('v-banner').onclick = null;
            }
        }

        async function uploadBio(newBio) {
            if(newBio === myData.bio) return;
            await silentUpdate('bio', newBio);
        }

        async function silentUpdate(field, value) {
            const res = await fetch('/update-profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username: myData.username, field, value })
            });
            const d = await res.json();
            if(d.success) {
                myData = d.user;
                // Update local UI only
                if(field === 'profilePic') document.getElementById('v-pfp').src = value;
                if(field === 'banner') document.getElementById('v-banner').style.background = `url(${value}) center/cover`;
            }
        }

        function closeModal() { document.getElementById('profile-modal').style.display = 'none'; }

        document.getElementById('pfp-up').onchange = (e) => {
            const reader = new FileReader();
            reader.readAsDataURL(e.target.files[0]);
            reader.onload = () => silentUpdate('profilePic', reader.result);
        };
        document.getElementById('banner-up').onchange = (e) => {
            const reader = new FileReader();
            reader.readAsDataURL(e.target.files[0]);
            reader.onload = () => silentUpdate('banner', reader.result);
        };
    </script>
</body>
</html>
